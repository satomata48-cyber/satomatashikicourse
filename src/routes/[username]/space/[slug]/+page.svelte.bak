<script lang="ts">
	import { onMount } from 'svelte'
	import { page } from '$app/stores'
	import { goto } from '$app/navigation'
	import { createSupabaseBrowserClient } from '$lib/supabase'
	import { authStore } from '$lib/stores/auth'
	
	export let data
	
	const supabase = createSupabaseBrowserClient()
	
	$: username = $page.params.username
	$: slug = $page.params.slug
	
	let space: any = null
	let courses: any[] = []
	let instructor: any = null
	let loading = true
	let error = ''
	let isEnrolled = false
	let enrollmentStatus: string | null = null
	let student: any = null
	
	// リダイレクト済みフラグ
	let hasRedirected = false
	let mounted = false
	
	onMount(() => {
		mounted = true
	})
	
	// リアクティブにパラメータが設定されたらデータを読み込み
	$: if (mounted && username && slug && username !== 'undefined' && slug !== 'undefined' && !hasRedirected) {
		loadSpaceData().then(() => {
			if (data?.user && !hasRedirected) {
				checkEnrollmentStatus()
			}
		})
	}
	
	async function loadSpaceData() {
		try {
			// まず、usernameで講師情報を取得
			const { data: profileData, error: profileError } = await supabase
				.from('profiles')
				.select('id, display_name, avatar_url, bio')
				.eq('username', username)
				.single()
			
			if (profileError || !profileData) {
				throw new Error('講師が見つかりません')
			}
			
			// スペース情報を取得
			const { data: spaceData, error: spaceError } = await supabase
				.from('spaces')
				.select('*')
				.eq('slug', slug)
				.eq('instructor_id', profileData.id)
				.single()
			
			if (spaceError) throw spaceError
			if (!spaceData) throw new Error('スペースが見つかりません')
			if (!spaceData.is_active) throw new Error('このスペースは現在利用できません')
			
			// 公開制御: 非公開スペースは404を表示
			if (!spaceData.is_public) {
				throw new Error('このページは公開されていません')
			}
			
			space = spaceData
			instructor = profileData  // プロフィールデータを講師情報として使用
			
			// 公開コース一覧を取得
			const { data: coursesData, error: coursesError } = await supabase
				.from('courses')
				.select(`
					*,
					lessons:lessons(count)
				`)
				.eq('space_id', space.id)
				.eq('is_published', true)
				.order('created_at', { ascending: false })
			
			if (coursesError) throw coursesError
			courses = coursesData || []
			
		} catch (err: any) {
			error = err.message
			console.error('Load space data error:', err)
		} finally {
			loading = false
		}
	}
	
	async function checkEnrollmentStatus() {
		try {
			// space_studentsテーブルから登録状況を確認
			const { data: enrollment, error: enrollmentError } = await supabase
				.from('space_students')
				.select('status')
				.eq('student_id', data.user.id)
				.eq('space_id', space.id)
				.single()
			
			if (enrollment) {
				isEnrolled = true
				enrollmentStatus = enrollment.status
				
				// 既に登録済みでアクティブな場合は、ダッシュボードに自動リダイレクト
				// TEMPORARY DISABLE: リダイレクトループを防ぐため一時的に無効化
				// if (enrollment.status === 'active' && !hasRedirected) {
				// 	console.log('Redirecting enrolled student to dashboard')
				// 	hasRedirected = true
				// 	goto(`/${username}/space/${slug}/dashboard`)
				// 	return
				// }
				
				// profilesテーブルから生徒情報を取得
				const { data: profileData, error: profileError } = await supabase
					.from('profiles')
					.select('id, display_name, email')
					.eq('id', data.user.id)
					.single()
				
				if (profileData) {
					student = profileData
				}
			}
		} catch (err) {
			// 登録されていない場合はエラーになるが、それは正常
			console.log('Not enrolled yet:', err)
		}
	}
	
	function formatCurrency(price: number, currency: string): string {
		return new Intl.NumberFormat('ja-JP', {
			style: 'currency',
			currency: currency
		}).format(price)
	}
	
	function formatDuration(hours: number | null): string {
		if (!hours) return ''
		if (hours < 1) return '1時間未満'
		return `約${hours}時間`
	}
	
	// ランディングページコンテンツの処理
	$: landingPageContent = space?.landing_page_content || {
		sections: [],
		metadata: {},
		theme: { primaryColor: '#3B82F6', accentColor: '#F59E0B' }
	}
	
	$: theme = landingPageContent.theme || { primaryColor: '#3B82F6', accentColor: '#F59E0B' }
</script>

<svelte:head>
	<title>{space?.title || 'Loading...'} | オンライン学習スペース</title>
	<meta name="description" content={space?.description || ''} />
	{#if theme}
		<style>
			:root {
				--primary-color: {theme.primaryColor};
				--accent-color: {theme.accentColor};
			}
		</style>
	{/if}
</svelte:head>

{#if loading}
	<div class="min-h-screen flex justify-center items-center">
		<div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
	</div>
{:else if error}
	<div class="min-h-screen flex justify-center items-center">
		<div class="max-w-md text-center">
			<svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.99-.833-2.598 0L4.216 15.5C3.445 16.333 4.406 18 5.946 18z"/>
			</svg>
			<h1 class="text-2xl font-bold text-gray-900 mb-2">スペースが見つかりません</h1>
			<p class="text-gray-600">{error}</p>
		</div>
	</div>
{:else if space}
	<div class="min-h-screen bg-gray-50">
		<!-- セクションを動的に表示 -->
		{#if landingPageContent.sections && landingPageContent.sections.length > 0}
			{#each landingPageContent.sections as section}
				{#if section.type === 'header'}
					<!-- ヘッダー -->
					<nav class="shadow-sm border-b" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
						<div class="max-w-7xl mx-auto px-6 py-4">
							<div class="flex justify-between items-center">
								<div class="flex items-center space-x-2">
									<div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background-color: {theme.primaryColor}">
										<span class="text-white font-bold text-sm">{space.title.charAt(0)}</span>
									</div>
									<span class="font-medium" style="color: {section.textColor || '#111827'}">{space.title}</span>
								</div>
								<div class="flex items-center space-x-4">
									{#if student}
										<span class="text-sm opacity-70">こんにちは、{student.display_name}さん</span>
										<a href="/{username}/space/{slug}/student" class="font-medium transition-colors hover:opacity-70" style="color: {section.textColor || '#111827'}">
											マイページ
										</a>
									{:else}
										<button on:click={() => window.location.href = `/${username}/space/${slug}/login`} class="font-medium transition-colors hover:opacity-70" style="color: {section.textColor || '#111827'}">
											ログイン
										</button>
										<a href="/{username}/space/{slug}/enroll" class="text-white px-4 py-2 rounded-lg font-medium transition-opacity hover:opacity-90" style="background-color: {theme.primaryColor}">
											生徒登録
										</a>
									{/if}
								</div>
							</div>
						</div>
					</nav>
				{:else if section.type === 'hero'}
					<!-- ヒーローセクション -->
					<section class="py-20 relative overflow-hidden text-white" style="background-color: {theme.primaryColor}">
						<div class="absolute inset-0 bg-black opacity-10"></div>
						<div class="relative container mx-auto px-6 text-center">
							<div class="max-w-4xl mx-auto">
								<h1 class="text-5xl font-bold mb-6 mt-8">{section.title}</h1>
								<p class="text-xl mb-8 opacity-90">{section.content}</p>
								{#if section.buttonText}
									<a href={section.buttonUrl || '#'} class="inline-flex items-center bg-white text-gray-900 px-8 py-4 rounded-lg font-semibold hover:scale-105 transition-transform duration-200">
										{section.buttonText}
										<svg class="ml-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
										</svg>
									</a>
								{/if}
							</div>
						</div>
					</section>
				{:else if section.type === 'courses'}
					<!-- コース一覧 -->
					{#if courses.length > 0}
						<section class="py-16" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
							<div class="container mx-auto px-6">
								<div class="text-center mb-12">
									<h2 class="text-3xl font-bold mb-4" style="color: {section.textColor || '#111827'}">{section.title}</h2>
									<p class="text-xl opacity-80">{section.content}</p>
								</div>
								<div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
									{#each courses as course}
										<div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition-shadow duration-300">
											<div class="p-6">
												<div class="flex items-start justify-between mb-4">
													<h3 class="text-xl font-semibold text-gray-900 mb-2">{course.title}</h3>
													<div class="text-right">
														{#if course.is_free}
															<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">無料</span>
														{:else}
															<span class="text-lg font-bold text-gray-900">{formatCurrency(course.price, course.currency)}</span>
														{/if}
													</div>
												</div>
												<p class="text-gray-600 mb-4 line-clamp-3">{course.description || 'このコースについての詳細な説明をご覧いただけます。'}</p>
												<div class="flex items-center justify-between text-sm text-gray-500 mb-4">
													<div class="flex items-center space-x-4">
														<span class="flex items-center">
															<svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
																<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
															</svg>
															{course.lessons?.[0]?.count || 0} レッスン
														</span>
														{#if course.estimated_duration_hours}
															<span class="flex items-center">
																<svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
																	<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
																</svg>
																{formatDuration(course.estimated_duration_hours)}
															</span>
														{/if}
													</div>
												</div>
												<a href="/{username}/space/{slug}/course/{course.id}" class="block w-full text-center text-white py-3 rounded-lg font-medium transition-opacity hover:opacity-90 duration-200" style="background-color: {theme.primaryColor}">
													詳細を見る
												</a>
											</div>
										</div>
									{/each}
								</div>
							</div>
						</section>
					{/if}
				{:else if section.type === 'instructor'}
					<!-- 講師紹介 -->
					{#if instructor}
						<section class="py-16" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
							<div class="container mx-auto px-6">
								<div class="max-w-4xl mx-auto text-center">
									<h2 class="text-3xl font-bold mb-8" style="color: {section.textColor || '#111827'}">{section.title}</h2>
									<div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
										<div class="flex-shrink-0">
											{#if instructor.avatar_url}
												<img class="h-32 w-32 rounded-full object-cover" src={instructor.avatar_url} alt={instructor.display_name} />
											{:else}
												<div class="h-32 w-32 rounded-full bg-gray-300 flex items-center justify-center">
													<svg class="h-16 w-16 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
													</svg>
												</div>
											{/if}
										</div>
										<div class="flex-1 text-center md:text-left">
											<h3 class="text-2xl font-semibold mb-4" style="color: {section.textColor || '#111827'}">{instructor.display_name || 'Unknown Instructor'}</h3>
											<p class="leading-relaxed opacity-80">{section.content}</p>
										</div>
									</div>
								</div>
							</div>
						</section>
					{/if}
				{:else if section.type === 'cta'}
					<!-- CTA -->
					<section class="py-16" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
						<div class="container mx-auto px-6 text-center">
							<h2 class="text-3xl font-bold mb-4">{section.title}</h2>
							<p class="text-xl mb-8 opacity-90">{section.content}</p>
							{#if section.buttonText && !isEnrolled}
								<a href={section.buttonUrl || '#'} class="inline-flex items-center bg-white text-gray-900 px-8 py-4 rounded-lg font-semibold hover:scale-105 transition-transform duration-200">
									{section.buttonText}
									<svg class="ml-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
									</svg>
								</a>
							{/if}
						</div>
					</section>
				{:else if section.type === 'features'}
					<!-- 特徴リスト -->
					<section class="py-16" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
						<div class="container mx-auto px-6">
							<h2 class="text-3xl font-bold text-center mb-12" style="color: {section.textColor || '#111827'}">{section.title}</h2>
							<div class="max-w-2xl mx-auto whitespace-pre-line">
								{section.content}
							</div>
						</div>
					</section>
				{:else if section.type === 'image-text'}
					<!-- 画像+テキスト -->
					<section class="py-16" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
						<div class="container mx-auto px-6">
							<h3 class="text-3xl font-bold mb-6" style="color: {section.textColor || '#111827'}">{section.title}</h3>
							{#if section.imageUrl}
								<img src={section.imageUrl} alt={section.title} class="w-full max-w-3xl mx-auto h-64 object-cover rounded-lg mb-6" />
							{/if}
							<p class="text-lg whitespace-pre-line max-w-3xl mx-auto opacity-80">{section.content}</p>
						</div>
					</section>
				{:else if section.type === 'faq'}
					<!-- FAQ -->
					<section class="py-16" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
						<div class="container mx-auto px-6">
							<h3 class="text-3xl font-bold mb-8 text-center" style="color: {section.textColor || '#111827'}">{section.title}</h3>
							<div class="space-y-4 max-w-3xl mx-auto">
								{#each section.content.split('\n\n') as qa}
									<div class="p-6 rounded-lg" style="background-color: color-mix(in srgb, {section.backgroundColor || '#ffffff'} 95%, black)">
										<p class="whitespace-pre-line">{qa}</p>
									</div>
								{/each}
							</div>
						</div>
					</section>
				{:else if section.type === 'footer'}
					<!-- フッター -->
					<footer class="py-8" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
						<div class="container mx-auto px-6">
							<div class="max-w-7xl mx-auto">
								<div class="text-center">
									<p class="text-sm opacity-80">{section.content}</p>
								</div>
							</div>
						</div>
					</footer>
				{:else}
					<!-- デフォルト(テキスト) -->
					<section class="py-16" style="background-color: {section.backgroundColor || '#ffffff'}; color: {section.textColor || '#111827'}">
						<div class="container mx-auto px-6">
							<h3 class="text-3xl font-bold mb-6" style="color: {section.textColor || '#111827'}">{section.title}</h3>
							<p class="text-lg whitespace-pre-line max-w-3xl mx-auto opacity-80">{section.content}</p>
						</div>
					</section>
				{/if}
			{/each}
		{:else}
			<!-- デフォルト表示(セクションが未設定の場合) -->
			<nav class="bg-white shadow-sm border-b">
				<div class="max-w-7xl mx-auto px-6 py-4">
					<div class="flex justify-between items-center">
						<div class="flex items-center space-x-2">
							<div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
								<span class="text-white font-bold text-sm">{space.title.charAt(0)}</span>
							</div>
							<span class="text-gray-900 font-medium">{space.title}</span>
						</div>
					</div>
				</div>
			</nav>

			<section class="py-20 text-white relative overflow-hidden" style="background: linear-gradient(135deg, {theme.primaryColor}, color-mix(in srgb, {theme.primaryColor} 80%, transparent))">
				<div class="absolute inset-0 bg-black opacity-10"></div>
				<div class="relative container mx-auto px-6 text-center">
					<div class="max-w-4xl mx-auto">
						<h1 class="text-5xl font-bold mb-6 mt-8">{space.title}</h1>
						<p class="text-xl mb-8 text-white/90">{space.description}</p>
					</div>
				</div>
			</section>
		{/if}
	</div>
{/if}

<style>
	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
</style>